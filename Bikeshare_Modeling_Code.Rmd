---
title: "Bikeshare_Bayesian_Modeling"
author: "Yuta Baba & Saahithi Rao"
date: "11/19/18"
output: pdf_document
---
#Loading libraries
```{r}
library(data.table)
library(lubridate)
library(tidyr)
library(stringr)
library(Hmisc)
library(plyr)
library(dplyr)
library(ggplot2)
library(rethinking)
library(tictoc)
library(parallel)
```

#The following code was used to define functions to read original files
#Since the original data were too big, the csv file labelled 'bike_data.csv' was exported and used for analysis

#For analaysis, please skip to line 135.

#Load Data
```{r, eval=FALSE}
read_files <- function(path, pattern = "*.csv", city_name){
  files <- list.files(path, pattern)
  files2 <- paste0(path, "/", files)
  if(city_name == "Chicago"){
    files2 <- files2[1:3]
  }
  bikes <- rbindlist(lapply(files2, fread))
  if(city_name == "Chicago"){
    files3 <- paste0(path, "/", files)[4]
    bikes2 <- rbindlist(lapply(files3, fread))
    bikes2$start_time <- paste0(bikes2$start_time, ":00")
    bikes <- rbind(bikes, bikes2)
  }
  bikes$City <- city_name
  return(bikes)
}

bikes_bos <- read_files(path = "MATH315_FP_Data/Boston_Bike", city_name = "Boston")
bikes_NY  <- read_files(path = "MATH315_FP_Data/NY_Bike", city_name = "NY")
bikes_chi  <- read_files(path = "MATH315_FP_Data/Chicago_Bike", city_name = "Chicago")

bosWeather17 <- fread("MATH315_FP_Data/Weather_data/BosWeather2017.csv")
NYWeather17 <- fread("MATH315_FP_Data/Weather_data/NYWeather2017.csv")
chiWeather17 <- fread("MATH315_FP_Data/Weather_data/ChiWeather2017.csv")
```

#Clean Data
#Join bikeshare data from three cities
```{r}
#create some variables, format them and combine bike data
colnames(bikes_NY) <- colnames(bikes_bos)
bikes <- rbind(bikes_bos, bikes_NY) %>% 
  dplyr::select(-tripduration, -c(stoptime:bikeid)) %>% 
  mutate(
  starttime = ymd_hms(starttime),
  `birth year` = ifelse(`birth year` == "\\N", NA, `birth year`),
  `birth year` = as.numeric(`birth year`)
  ) 

bikes_chi <- bikes_chi %>% 
  dplyr::select(-trip_id, -c(end_time:to_station_name)) %>% 
  mutate(
    start_time = mdy_hms(start_time),
    gender = ifelse(gender == "Male", 1,
                    ifelse(gender == "Female", 2, 0))
  ) %>% arrange(start_time)

bikes_chi <- bikes_chi[, c(1, 2, 4, 3, 5)]
colnames(bikes_chi) <- colnames(bikes)

bikes <- rbind(bikes, bikes_chi)
```

##Summarize the data 
```{r}
bikes <- bikes %>% 
  separate(starttime, sep = " ", c("date", "start_time"), remove = FALSE) %>% 
  separate(date, sep = "-", c("startyear", "startmonth", "startday"), remove = FALSE) %>% 
  mutate(
    date = ymd(date),
    startyear = as.numeric(startyear),
    age = startyear - `birth year`
  )

bikes2 <- bikes %>% mutate(
  usertype = ifelse(usertype == "Subscriber", 1, 0),
  gender = ifelse(gender == 1, 1, 0)) %>% 
  group_by(date, City) %>% 
  summarize(
    ntrips = n(),
    per_subscriber = sum(usertype)/ n(),
    per_male = sum(gender)/n(),
    median_age = median(age, na.rm = T)
    ) %>% mutate(
      weekends = weekdays(date),
      weekends = ifelse(weekends == "Saturday" | weekends == "Sunday", 1, 0)
    )
```

##Clean Weather Data
```{r}
bosWeather17 <- bosWeather17 %>% mutate(
  NAME = gsub(pattern = "(.*),.*", "\\1", bosWeather17$NAME) %>% 
    tolower() %>% 
    capitalize(),
  DATE = mdy(DATE)
)  %>% dplyr::select(-STATION, -PGTM)

NYWeather17 <- NYWeather17 %>% mutate(
  NAME = "NY",
  DATE = mdy(DATE)
)

chiWeather17 <- chiWeather17 %>% mutate(
  NAME = "Chicago",
  DATE = mdy(DATE)
) %>% dplyr::select(-STATION)

#combine weather data
weather17 <- rbind(bosWeather17, NYWeather17, chiWeather17)
```

#Join bikeshare and weather data
```{r}
bikes3 <- left_join(bikes2, weather17, by = c("date" = "DATE", "City" = "NAME"))
write.csv(bikes3, "bike_data.csv")
```

#Export data
#Note: These files will be used for all analysis. 
```{r}
bike_data <- read.csv("bike_data.csv")
city_info <- read.csv("Extra.csv") #Contains stations and entropy
```

#Adding season variable to dataset based on month
```{r}
bike_data$month <- month(bike_data$date)
bike_data$season <- mapvalues(bike_data$month, c(1:12), c(rep(c("winter"), 2), rep(c("spring"), 3), rep(c("summer"), 3), rep(c("fall"), 3), "winter"))            
```

#Joining the date to create final dataset
```{r}
bike_data2 <- left_join(bike_data, city_info, by = c("City"= "City"))
bike_data2 <- bike_data2 %>% dplyr::select(City, ntrips, per_subscriber, per_male, median_age, weekends, AWND, PRCP, SNOW, TMAX, season, Stations, Entropy) %>% as.data.frame() %>% 
  mutate(
    #converting snow, stations, and cities to factor variables 
    SNOW = ifelse(SNOW == 0, 0, 1), 
    Stations = ifelse(Stations <200, 0, 1),
    cityb =  ifelse(bike_data2$City == "Boston", 1, 0),
    cityc =  ifelse(bike_data2$City == "Chicago", 1, 0)
  )
```

#Exploratory Data Analysis
```{r}
summary(bike_data2)
sd(bike_data2$ntrips)
sd(bike_data2$per_male)
sd(bike_data2$TMAX)
sd(bike_data2$per_subscriber)
sd(bike_data2$AWND)
sd(bike_data2$PRCP)
sd(bike_data2$median_age)
table(bike_data2$SNOW)
table(bike_data2$weekends)

hist(bike_data2$ntrips, main = "Histogram of Number of Trips", xlab = "Number of Trips")
plot(log(ntrips)~TMAX, data = bike_data2)
ggplot(bike_data2, aes(x = TMAX, y = log(ntrips))) + geom_point() + facet_wrap(.~City) + labs(x = "Maximum Temperature (F)", y = "Logged Number of Trips", title = "Logged Number of Trips vs Maximum Temperature for Each City" )
NYC <- bike_data2[which(bike_data2$City=="NY"),]
g <- lm(log(ntrips) ~ TMAX, data=boston)
plot(log(ntrips) ~ TMAX, data=boston)
abline(g)

plot(log(ntrips)~median_age, data = bike_data2) #alright
ggplot(bike_data2, aes(x = median_age, y = log(ntrips))) + geom_point() + facet_wrap(.~City) 
plot(log(ntrips)~AWND, data = bike_data2) #alright
plot(log(ntrips)~per_male, data = bike_data2) #alright
ggplot(bike_data2, aes(x = per_male, y = log(ntrips), col = as.factor(weekends))) + geom_point() + facet_wrap(.~City) + labs(x = "Proportion of Males", y = "Logged Number of Trips", title = "Logged Number of Trips vs Percentage of Males for Each City") + scale_color_discrete(name = "Weekends", labels = c("Weekdays", "Weekends"))
plot(log(ntrips)~per_subscriber, data = bike_data2) #left skewed
ggplot(bike_data2, aes(x = per_subscriber, y = log(ntrips))) + geom_point() + facet_wrap(.~City) 
plot(log(ntrips)~month, data = bike_data2) #alright
```

##Model Building
#Standardizing numeric variables 
```{r}
bike_data3 <- bike_data2 %>%
  mutate_at(
    vars(AWND, PRCP, per_subscriber, per_male, median_age, TMAX), scale)
```

#Model without season and demographic data
```{r}
bike <- bike_data3 %>% dplyr::select(cityb, cityc, ntrips, PRCP, SNOW, TMAX, weekends, AWND)
set.seed(1000)
tic("MCMC Simulation")
bike.pois <- map2stan(
  alist(
    ntrips ~ dpois(lambda),
    log(lambda) <-  a + b_boston*cityb + b_chicago*cityc + b_temp*TMAX + b_prcp*PRCP + b_snow*SNOW + b_wind*AWND + b_weekend*weekends,
    a ~ dnorm(9.88, 10), 
    c(b_temp, b_prcp, b_wind, b_snow, b_weekend) ~ dnorm(0,5),
    c(b_boston, b_chicago) ~ dnorm(0,3)
  ),
  data = bike,
  cores = 4,
  iter = 12000,
  warmup = 6000,
  chain = 4
)
toc()
plot(bike.pois)
precis(bike.pois, depth=2)
bike.pois
```

#Model without season parameter
```{r}
bike <- bike_data3 %>% dplyr::select(citya, cityb, ntrips, TMAX, PRCP, AWND, per_male, per_subscriber, median_age)
set.seed(1000)
tic("MCMC Simulation")
bike.pois <- map2stan(
  alist(
    ntrips ~ dpois(lambda),
    log(lambda) <-  a + b_boston*cityb + b_chicago*cityc + b_temp*TMAX + b_prcp*PRCP + b_snow*SNOW + b_wind*AWND + b_weekend*weekends + b_age*median_age + b_male*per_male + b_subscriber*per_subscriber,
    a ~ dnorm(9.88, 10), 
    c(b_temp, b_prcp, b_wind, b_snow, b_weekend) ~ dnorm(0,5),
    c(b_boston, b_chicago) ~ dnorm(0,3)
  ),
  data = bike,
  cores = 4,
  iter = 12000,
  warmup = 6000,
  chain = 4
)
toc()
plot(bike.pois)
precis(bike.pois, depth=2)
bike.pois
```

#Mixed Effects Model
```{r, eval=FALSE}
bike <- bike_data3 %>% dplyr::select(City, ntrips, TMAX, PRCP, SNOW, AWND, weekends, per_male, per_subscriber, median_age, season)
set.seed(1000)
tic("MCMC Simulation")
bike_model <- map2stan(
  alist(
    ntrips ~ dpois(lambda),
    log(lambda) <- a_season[season] + a_city[City] + b_temp*TMAX + b_prcp*PRCP + b_snow*SNOW + b_wind*AWND + b_weekend*weekends + b_age*median_age + b_male*per_male + b_subscriber*per_subscriber,
    a_season[season] ~ dnorm(9.88, 12),
    c(b_temp, b_prcp, b_wind, b_age, b_snow, b_weekend, b_male, b_subscriber) ~ dnorm(0,5),
    c(b_boston, b_chicago) ~ dnorm(0,3)
    a_city[City] ~ dnorm(0, sigma_city), 
    sigma_city ~ dcauchy(0, 1)
  ),
  data = bike,
  cores = 4,
  iter = 12000,
  warmup = 6000,
  chain = 4
)
toc() #7.5hrs
plot(bike_model, ncol = 4)
str(bike_model)
precis(bike_model, depth=2)
```

#MOdel with city characteristics (number of stations and entropy)
```{r, eval=FALSE}
bike <- bike_data3 %>% dplyr::select(cityb, cityc, ntrips, TMAX, PRCP, SNOW, AWND, weekends, per_male, per_subscriber, median_age, Stations, Entropy)
set.seed(1000)
tic("MCMC Simulation")
bike.pois2 <- map2stan(
  alist(
    ntrips ~ dpois(lambda),
    log(lambda) <-  a + b_boston*cityb + b_chicago*cityc + b_temp*TMAX + b_prcp*PRCP + b_snow*SNOW + b_wind*AWND + b_weekend*weekends + b_age*median_age + b_male*per_male + b_subscriber*per_subscriber + b_entropy*Entropy + b_station*Stations,
    a ~ dnorm(9.88, 10), 
    b_boston ~ dnorm(0, 3),
    b_chicago ~ dnorm(0, 3),
    c(b_temp, b_prcp, b_wind, b_age, b_snow, b_weekend, b_male, b_subscriber, b_entropy, b_station) ~ dnorm(0, 5)
  ),
  data = bike,
  cores = 4,
  iter = 12000,
  warmup = 6000,
  chain = 4
)
toc()
```

#Final Model: Includes all predictor variables 
```{r, eval=FALSE}
bike <- bike_data3 %>% dplyr::select(cityb, cityc, ntrips, TMAX, PRCP, SNOW, AWND, weekends, per_male, per_subscriber, median_age, season)
set.seed(1000)
tic("MCMC Simulation")
bike_model <- map2stan(
  alist(
    ntrips ~ dpois(lambda),
    log(lambda) <- a_season[season] + b_boston*cityb + b_chicago*cityc + b_temp*TMAX + b_prcp*PRCP + b_snow*SNOW + b_wind*AWND + b_weekend*weekends + b_age*median_age + b_male*per_male + b_subscriber*per_subscriber,
    a_season[season] ~ dnorm(9.88, 12),
    c(b_temp, b_prcp, b_wind, b_age, b_snow, b_weekend, b_male, b_subscriber) ~ dnorm(0,5),
    c(b_boston, b_chicago) ~ dnorm(0,3)
  ),
  data = bike,
  cores = 4,
  iter = 12000,
  warmup = 6000,
  chain = 4
)
toc()
plot(bike_model)
precis(bike_model, depth=2)
Final_model #WAIC: 974654.76
```

#Loading model data
```{r}
load("stan_bike_fitFri8.Rdata") #Final model
Final_model <- bike_model
load("stan_bike_fitFri10.Rdata") #mixed effect model
mixedEffectModel <- bike_model
load("bike_pois_Fri.RData") #model without season and demographics
Without_season_demographics <- bike.pois
load("bike_pois_Fri2.RData") #model without season
without_season <- bike.pois
```

#Plots of the parameter estimates 
```{r}
fev.coefs <- coeftab(Final_model, Without_season_demographics, without_season)
plot(fev.coefs)
```

#WAIC Plot
```{r}
compare(Final_model, Without_season_demographics, without_season)
plot(compare(Final_model, Without_season_demographics, without_season))
```

#Posterior Prediction Plot
```{r}
bike_data3 <- bike_data2 %>%
  mutate_at(
    vars(AWND, PRCP, per_subscriber, per_male, median_age, TMAX), funs(scale(.)[ ,1]))
bike2 <- bike_data3 %>% dplyr::select(City, cityb, cityc, ntrips, TMAX, PRCP, SNOW, AWND, weekends, per_male, per_subscriber, median_age, season)

set.seed(1000)
bike.link <- link(Final_model)

set.seed(1000)
bike.sim <- sim(Final_model)

bike_plot_df <- bike2 %>%
  mutate(
    prob = apply(bike.link, 2, mean),
    prob.lo = apply(bike.link, 2, PI, prob=0.89)[1,],
    prob.hi = apply(bike.link, 2, PI, prob=0.89)[2,],
    yi = apply(bike.sim, 2, mean),
    y.lo = apply(bike.sim, 2, PI, prob=0.89)[1,],
    y.hi = apply(bike.sim, 2, PI, prob=0.89)[2,]
  )

p2 <- ggplot(data = bike_plot_df, aes(x = season)) +
  geom_linerange(aes(ymin = y.lo, ymax = y.hi), position = position_dodge(width = 1)) +
  geom_point(aes(y = yi, color = "Predicted", shape = "Predicted"), position = position_dodge(width = 1)) + facet_wrap(.~City) + 
  geom_point(data = bike_plot_df, aes(y = ntrips, color = "Empirical", shape = "Empirical"), position = position_dodge(width = 1)) +
  labs(x = "Season", y = "Number of Bike Trips", title = "Draws from the Posterior of the Average Daily Number of Bike Trips") + 
  scale_colour_manual(name ="Count", labels = c(Predicted = "Predicted Count", Empirical = "Empirical Count"), values = c(Predicted = "blue", Empirical = "red")) +
  scale_shape_manual(name ="Count", labels = c(Predicted = "Predicted Count", Empirical = "Empirical Count"), values = c(Predicted = 1, Empirical = 2)) 

bike_plot_df$ntrips - bike_plot_df$y
```

#Counterfactual plot
```{r}
#create a data frame (take the average for all the numeric variables except for precipitation. The value for binary variables are chosen as follows.)
bike2.avg <-  bike2 %>%
dplyr::select(TMAX, AWND, per_male, per_subscriber, median_age) %>%
apply(MARGIN = 2, FUN = mean) 

predictor.data <- data.frame(
PRCP = seq(-0.5, 12.3, 0.1),
cityb = 1,
cityc = 0,
SNOW = 0,
weekends = 0,
season = "spring",
t(bike2.avg)
)

#credible interval
mu <- link(Final_model, data = predictor.data, reflsh = 0)
#prediction interval
y.sim <- sim(Final_model, data = predictor.data, reflsh = 0)

predictor.data <- predictor.data %>%
mutate(
mu.mean = apply(mu, 2, mean),
mu.PIlo = apply(mu, 2, PI)[1,],
mu.PIhi = apply(mu, 2, PI)[2,],
y.PIlo = apply(y.sim, 2, PI)[1,],
y.PIhi = apply(y.sim, 2, PI)[2,]
)

#visualization
ggplot(data = predictor.data) +
geom_line(mapping = aes(x = PRCP, y = mu.mean)) +
geom_ribbon(mapping = aes(x = PRCP, ymin = mu.PIlo, ymax = mu.PIhi),
fill = "red", alpha = 0.3) +
geom_ribbon(mapping = aes(x = PRCP, ymin = y.PIlo, ymax = y.PIhi),
fill = "steelblue", alpha = 0.2) + 
labs(x = "Standardized Precipitation",
y = "Daily Number of Bike Trips",
caption = "Black line shows the mean, red area shows the 89% credible interval, and blue area shows the 89% prediction interval. \n (Maximum Temperature, Average Wind Speed, Percentage of Males, Percentage of Subscribers, Median age held at their mean value. City is Boston, no Snow, Weekends, Spring are chosen.)", title = "Counterfactual Plot for Boston: Daily Number of Bike Trips against Standardized Precipitation")

```